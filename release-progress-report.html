<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Release Progress Report Generator</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background:linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
      min-height:100vh; color:#333;
    }
    .container { max-width:1600px; margin:0 auto; padding:24px; }

    .header { text-align:center; margin-bottom:32px; }
    .header h1 { font-size:2.5rem; font-weight:bold; color:#1f2937; margin-bottom:8px; }
    .header p { font-size:1.125rem; color:#6b7280; }

    .upload-section { background:#fff; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.1); padding:32px; margin-bottom:32px; }
    .upload-content { text-align:center; }
    .upload-icon { margin:0 auto 16px; width:64px; height:64px; font-size:3rem; }
    .upload-title { font-size:1.5rem; font-weight:600; color:#1f2937; margin-bottom:16px; }
    .upload-area { border:2px dashed #93c5fd; border-radius:12px; padding:24px; background:#fafafa; transition:.3s; cursor:pointer; }
    .upload-area:hover { border-color:#2563eb; background:#f1f5f9; }
    .upload-icon-inner { font-size:3rem; color:#60a5fa; margin-bottom:16px; }
    .upload-text { font-size:1.125rem; font-weight:500; color:#374151; margin-bottom:8px; }
    .upload-subtext { color:#6b7280; font-size:.875rem; }
    .processing { margin-top:16px; color:#3b82f6; font-size:1.125rem; display:none; }
    .processing.show { display:block; }
    .spinner { display:inline-block; width:20px; height:20px; border:3px solid #f3f4f6; border-radius:50%; border-top-color:#3b82f6; animation:spin 1s infinite; margin-right:10px; }
    @keyframes spin { to { transform:rotate(360deg) } }

    .dashboard { display:none; gap:32px; }
    .dashboard.show { display:flex; flex-direction:column; }

    .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:32px; }
    @media (min-width:1024px){ .metrics-grid{ grid-template-columns:repeat(5,1fr) } }

    .metric-card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,.1); border-left:4px solid; display:flex; align-items:center; }
    .metric-card.blue{border-left-color:#3b82f6} .metric-card.red{border-left-color:#ef4444}
    .metric-card.green{border-left-color:#10b981} .metric-card.yellow{border-left-color:#f59e0b}
    .metric-card.purple{border-left-color:#8b5cf6} .metric-card.indigo{border-left-color:#6366f1}
    .metric-card.pink{border-left-color:#ec4899} .metric-card.teal{border-left-color:#14b8a6}
    .metric-card.orange{border-left-color:#f97316} .metric-card.gray{border-left-color:#6b7280}

    .metric-icon{font-size:1.8rem;margin-right:12px}
    .metric-icon.blue{color:#3b82f6} .metric-icon.red{color:#ef4444}
    .metric-icon.green{color:#10b981} .metric-icon.yellow{color:#f59e0b}
    .metric-icon.purple{color:#8b5cf6} .metric-icon.indigo{color:#6366f1}
    .metric-icon.pink{color:#ec4899} .metric-icon.teal{color:#14b8a6}
    .metric-icon.orange{color:#f97316} .metric-icon.gray{color:#6b7280}

    .metric-content h3{font-size:.8rem;font-weight:500;color:#6b7280;margin-bottom:4px}
    .metric-content p{font-size:1.5rem;font-weight:bold;color:#111827}

    .charts-section{ display:grid; grid-template-columns:1fr; gap:24px; margin-bottom:32px; }
    @media (min-width:1024px){ .charts-section{ grid-template-columns:1fr 1fr } }

    .chart-card{ background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .chart-title{ font-size:1.25rem; font-weight:600; color:#374151; margin-bottom:16px; display:flex; align-items:center; }
    .chart-title-icon{ font-size:1.5rem; margin-right:8px; }
    .chart-title-icon.blue{color:#3b82f6} .chart-title-icon.green{color:#10b981} 
    .chart-title-icon.red{color:#ef4444} .chart-title-icon.purple{color:#8b5cf6}
    .chart-title-icon.orange{color:#f97316} .chart-title-icon.pink{color:#ec4899}

    .summary-section{ background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .summary-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:16px; }
    .summary-title{ font-size:1.25rem; font-weight:600; color:#374151; display:flex; align-items:center; }
    .summary-title-icon{ font-size:1.5rem; color:#6366f1; margin-right:8px; }
    .export-btn{ background:#6366f1; color:#fff; border:none; padding:12px 16px; border-radius:8px; font-size:1rem; cursor:pointer; transition:.3s; display:flex; align-items:center; gap:8px; }
    .export-btn:hover{ background:#4f46e5; transform:translateY(-1px) }

    .summary-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:20px; }
    @media (min-width:1024px){ .summary-grid{ grid-template-columns:repeat(4,1fr) } }
    .summary-card{ background:#f9fafb; border-radius:8px; padding:16px; }
    .summary-card h4{ font-size:1rem; font-weight:600; color:#374151; margin-bottom:8px; }
    .summary-card ul{ list-style:none; font-size:.8rem; color:#6b7280; line-height:1.5; }
    .summary-card li{ margin-bottom:3px; }

    input[type="file"]{ display:none; }
    .error-message{ background:#fee2e2; color:#dc2626; padding:16px; border-radius:8px; margin-top:16px; text-align:center; display:none; }
    .error-message.show{ display:block; }

    .chart-body{ max-height:800px; overflow-y:auto; }
  </style>
</head>
<body>
<div class="container">
  <header class="header">
    <h1>üìä Release Progress Report</h1>
    <p>Comprehensive release tracking with story status, sprint analysis, and team performance metrics</p>
  </header>

  <div class="upload-section">
    <div class="upload-content">
      <div class="upload-icon">üìà</div>
      <h2 class="upload-title">Upload Release Data</h2>
      <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon-inner">üìÅ</div>
        <div class="upload-text">Click to upload or drag and drop</div>
        <div class="upload-subtext">Excel files (.xlsx, .xls) ‚Äî Select multiple files to compare changes over time</div>
        <input type="file" id="fileInput" accept=".xlsx,.xls" multiple/>
      </div>
      <div id="processing" class="processing">
        <div class="spinner"></div> Processing your Excel file...
      </div>
      <div id="error" class="error-message"></div>
    </div>
  </div>

  <div id="dashboard" class="dashboard">
    <div class="metrics-grid">
      <div class="metric-card blue">
        <div class="metric-icon blue">üìã</div>
        <div class="metric-content">
          <h3>Total Stories</h3><p id="totalStories">0</p>
        </div>
      </div>
      <div class="metric-card green">
        <div class="metric-icon green">‚úÖ</div>
        <div class="metric-content">
          <h3>Ready for Prod</h3><p id="readyForProd">0</p>
        </div>
      </div>
      <div class="metric-card purple">
        <div class="metric-icon purple">üöß</div>
        <div class="metric-content">
          <h3>In Progress</h3><p id="inProgress">0</p>
        </div>
      </div>
      <div class="metric-card orange">
        <div class="metric-icon orange">‚ö°</div>
        <div class="metric-content">
          <h3>Story Points</h3><p id="totalPoints">0</p>
        </div>
      </div>
      <div class="metric-card red">
        <div class="metric-icon red">üéØ</div>
        <div class="metric-content">
          <h3>Critical Stories</h3><p id="criticalStories">0</p>
        </div>
      </div>
      <div class="metric-card teal">
        <div class="metric-icon teal">üß™</div>
        <div class="metric-content">
          <h3>Total Test Cases</h3><p id="totalTestCases">0</p>
        </div>
      </div>
      <div class="metric-card indigo">
        <div class="metric-icon indigo">üìä</div>
        <div class="metric-content">
          <h3>Test Coverage</h3><p id="testCoverage">0%</p>
        </div>
      </div>
      <div class="metric-card indigo">
        <div class="metric-icon indigo">üêõ</div>
        <div class="metric-content">
          <h3>Total Defects</h3><p id="totalDefects">0</p>
        </div>
      </div>
      <div class="metric-card pink">
        <div class="metric-icon pink">üë•</div>
        <div class="metric-content">
          <h3>Active Sprints</h3><p id="activeSprints">0</p>
        </div>
      </div>
      <div class="metric-card gray">
        <div class="metric-icon gray">üì¶</div>
        <div class="metric-content">
          <h3>Products</h3><p id="totalProducts">0</p>
        </div>
      </div>
    </div>

    <div class="charts-section">
      <div class="chart-card">
        <div class="chart-title">
          <span class="chart-title-icon purple">üìä</span>
          Story Status Distribution
        </div>
        <div id="statusChart" class="chart-body"></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">
          <span class="chart-title-icon red">üéØ</span>
          Impact Analysis
        </div>
        <div id="impactChart" class="chart-body"></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">
          <span class="chart-title-icon blue">üèÉ</span>
          Sprint Distribution
        </div>
        <div id="sprintChart" class="chart-body"></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">
          <span class="chart-title-icon green">üì¶</span>
          Product Distribution
        </div>
        <div id="productChart" class="chart-body"></div>
      </div>

      <div class="chart-card full-width">
        <div class="chart-title">
          <span class="chart-title-icon blue">üìà</span>
          Progress Timeline
        </div>
        <div id="timelineChart" class="chart-body"></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">
          <span class="chart-title-icon orange">üë§</span>
          Assignee Workload
        </div>
        <div id="assigneeChart" class="chart-body"></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">
          <span class="chart-title-icon pink">‚ö°</span>
          Story Points by Status
        </div>
        <div id="pointsChart" class="chart-body"></div>
      </div>
    </div>

    <div id="changesSection" class="summary-section" style="display:none;margin-bottom:32px;">
      <div class="summary-header">
        <div class="summary-title">
          <span class="summary-title-icon">üìä</span>
          Changes Summary
        </div>
        <div id="changesTimestamp" style="font-size:0.9rem;color:#6b7280;"></div>
      </div>
      <div id="changesContent" class="summary-grid">
        <!-- Changes will be populated here -->
      </div>
    </div>

    <div class="summary-section">
      <div class="summary-header">
        <div class="summary-title">
          <span class="summary-title-icon">üìã</span>
          Release Summary Report
        </div>

        <button id="copyEmailBtn" class="export-btn" onclick="copyEmailBody()" style="background:#0ea5e9;margin-right:8px;">
          <span>üìß</span> Copy Email Body
        </button>

        <button id="exportBtn" class="export-btn" onclick="exportReport()">
          <span>üíæ</span> Export PDF
        </button>
      </div>
      <div class="summary-grid">
        <div class="summary-card">
          <h4>Release Overview</h4>
          <ul>
            <li>‚Ä¢ Total Stories: <span id="summaryStories">0</span></li>
            <li>‚Ä¢ Story Points: <span id="summaryPoints">0</span></li>
            <li>‚Ä¢ Active Sprints: <span id="summarySprints">0</span></li>
            <li>‚Ä¢ Products: <span id="summaryProducts">0</span></li>
          </ul>
        </div>
        <div class="summary-card">
          <h4>Development Progress</h4>
          <ul>
            <li>‚Ä¢ Ready for Production: <span id="summaryReadyProd">0</span></li>
            <li>‚Ä¢ Ready for Testing: <span id="summaryReadyTest">0</span></li>
            <li>‚Ä¢ In Development: <span id="summaryInDev">0</span></li>
            <li>‚Ä¢ Ready for Development: <span id="summaryReadyDev">0</span></li>
          </ul>
        </div>
        <div class="summary-card">
          <h4>Quality Metrics</h4>
          <ul>
            <li>‚Ä¢ Total Test Cases: <span id="summaryTestCases">0</span></li>
            <li>‚Ä¢ Total Defects: <span id="summaryDefects">0</span></li>
            <li>‚Ä¢ Test Coverage: <span id="summaryTestCov">0%</span></li>
            <li>‚Ä¢ Critical Impact: <span id="summaryCritical">0</span></li>
            <li>‚Ä¢ High Impact: <span id="summaryHigh">0</span></li>
          </ul>
        </div>
        <div class="summary-card">
          <h4>Team Performance</h4>
          <ul>
            <li>‚Ä¢ Active Assignees: <span id="summaryAssignees">0</span></li>
            <li>‚Ä¢ Top Contributor: <span id="summaryTopAssignee">N/A</span></li>
            <li>‚Ä¢ Completion Rate: <span id="summaryCompletion">0%</span></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let globalMetrics = null;
let historicalData = []; // Store multiple report results

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('fileInput').addEventListener('change', e => {
    const files = Array.from(e.target.files);
    if (files.length > 0) processMultipleFiles(files);
  });

  // Enhanced drag & drop for multiple files
  const drop = document.querySelector('.upload-area');
  ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e => {
    e.preventDefault(); e.stopPropagation(); drop.style.borderColor = '#2563eb';
  }));
  ['dragleave','drop'].forEach(ev => drop.addEventListener(ev, e => {
    e.preventDefault(); e.stopPropagation(); drop.style.borderColor = '#93c5fd';
  }));
  drop.addEventListener('drop', e => {
    const files = Array.from(e.dataTransfer.files);
    if (files.length > 0) processMultipleFiles(files);
  });
});

function extractTimestamp(filename) {
  // Extract timestamp from format: "All Stories for Release 2.5.3-2025-09-24-13-04-17.xlsx"
  const match = filename.match(/(\d{4}-\d{2}-\d{2}-\d{2}-\d{2}-\d{2})/);
  if (match) {
    const dateStr = match[1];
    // Parse: 2025-09-24-13-04-17 -> 2025-09-24 13:04:17
    const parts = dateStr.split('-');
    const year = parts[0];
    const month = parts[1];
    const day = parts[2];
    const hour = parts[3];
    const minute = parts[4];
    const second = parts[5];
    
    const parsedDate = new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}`);
    console.log(`Extracted timestamp from "${filename}": ${parsedDate.toISOString()}`);
    return parsedDate;
  }
  console.log(`Could not extract timestamp from "${filename}", using current time`);
  return new Date(); // fallback to current time
}

async function processMultipleFiles(files) {
  showProcessing();
  historicalData = [];
  
  try {
    // Sort files by timestamp
    const fileData = files.map(file => ({
      file,
      timestamp: extractTimestamp(file.name),
      filename: file.name
    })).sort((a, b) => a.timestamp - b.timestamp);

    console.log('File processing order:');
    fileData.forEach((item, index) => {
      console.log(`${index + 1}. ${item.filename} -> ${item.timestamp.toLocaleString()}`);
    });

    console.log(`Processing ${fileData.length} files in chronological order...`);

    // Process each file
    for (const fileInfo of fileData) {
      const result = await processSingleFile(fileInfo.file);
      historicalData.push({
        timestamp: fileInfo.timestamp,
        filename: fileInfo.filename,
        metrics: result
      });
    }

    if (historicalData.length === 0) {
      throw new Error('No valid data found in uploaded files.');
    }

    // Use latest report as main display
    const latestReport = historicalData[historicalData.length - 1];
    globalMetrics = latestReport.metrics;

    // Enhanced dashboard with change indicators
    updateEnhancedDashboardWithChanges();
    showDashboard();
    hideProcessing();
    
    console.log(`Successfully processed ${historicalData.length} reports from ${historicalData[0].timestamp.toLocaleString()} to ${latestReport.timestamp.toLocaleString()}`);
    
  } catch (error) {
    console.error('Error:', error);
    hideProcessing();
    showError('Error processing files: ' + error.message);
  }
}

async function processSingleFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type:'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header:1, defval:'', raw:false });

        const processedData = processReleaseData(jsonData);
        if(processedData.length === 0){
          reject(new Error(`No valid data in ${file.name}`));
          return;
        }

        const metrics = calculateMetrics(processedData);
        resolve(metrics);
      } catch (error) {
        reject(new Error(`Failed to process ${file.name}: ${error.message}`));
      }
    };
    reader.readAsArrayBuffer(file);
  });
}

function calculateChanges() {
  if (historicalData.length < 2) return null;
  
  const current = historicalData[historicalData.length - 1].metrics;
  const previous = historicalData[historicalData.length - 2].metrics;
  
  // Calculate change as: current - previous (positive = increase, negative = decrease)
  return {
    totalStories: current.totalStories - previous.totalStories,
    readyForProd: current.readyForProd - previous.readyForProd,
    inProgress: current.inProgress - previous.inProgress,
    totalPoints: current.totalPoints - previous.totalPoints,
    criticalStories: current.criticalStories - previous.criticalStories,
    totalTestCases: current.totalTestCases - previous.totalTestCases,
    testCoverage: (parseFloat(current.testCoverage) - parseFloat(previous.testCoverage)).toFixed(1),
    totalDefects: current.totalDefects - previous.totalDefects,
    completionRate: (parseFloat(current.completionRate) - parseFloat(previous.completionRate)).toFixed(1)
  };
}

function formatChange(value, isPercentage = false) {
  if (value === 0) return '<span style="color:#6b7280;">‚óè</span>';
  const symbol = value > 0 ? '‚Üë' : '‚Üì';
  const color = value > 0 ? '#10b981' : '#ef4444';
  const suffix = isPercentage ? '%' : '';
  const displayValue = Math.abs(value);
  return `<span style="color:${color};font-weight:600;">${symbol} ${displayValue}${suffix}</span>`;
}

function updateEnhancedDashboardWithChanges() {
  const m = globalMetrics;
  const changes = calculateChanges();
  
  // Show/hide changes section based on whether we have multiple reports
  const changesSection = document.getElementById('changesSection');
  if (changes && historicalData.length >= 2) {
    changesSection.style.display = 'block';
    updateChangesSection(changes);
  } else {
    changesSection.style.display = 'none';
  }
  
  // Update basic metrics with change indicators
  document.getElementById('totalStories').innerHTML = `${m.totalStories} ${changes ? formatChange(changes.totalStories) : ''}`;
  document.getElementById('readyForProd').innerHTML = `${m.readyForProd} ${changes ? formatChange(changes.readyForProd) : ''}`;
  document.getElementById('inProgress').innerHTML = `${m.inProgress} ${changes ? formatChange(changes.inProgress) : ''}`;
  document.getElementById('totalPoints').innerHTML = `${m.totalPoints} ${changes ? formatChange(changes.totalPoints) : ''}`;
  document.getElementById('criticalStories').innerHTML = `${m.criticalStories} ${changes ? formatChange(changes.criticalStories) : ''}`;
  document.getElementById('totalTestCases').innerHTML = `${m.totalTestCases} ${changes ? formatChange(changes.totalTestCases) : ''}`;
  document.getElementById('testCoverage').innerHTML = `${m.testCoverage}% ${changes ? formatChange(changes.testCoverage, true) : ''}`;
  document.getElementById('totalDefects').innerHTML = `${m.totalDefects} ${changes ? formatChange(changes.totalDefects) : ''}`;
  document.getElementById('activeSprints').textContent = m.activeSprints;
  document.getElementById('totalProducts').textContent = m.totalProducts;

  // Update summary with timeline info
  const timelineInfo = historicalData.length > 1 
    ? `(${historicalData.length} reports from ${historicalData[0].timestamp.toLocaleDateString()} to ${historicalData[historicalData.length-1].timestamp.toLocaleDateString()})`
    : '';

  // Rest of summary updates...
  document.getElementById('summaryStories').textContent = m.totalStories;
  document.getElementById('summaryPoints').textContent = m.totalPoints;
  document.getElementById('summarySprints').textContent = m.activeSprints;
  document.getElementById('summaryProducts').textContent = m.totalProducts;
  
  document.getElementById('summaryReadyProd').textContent = m.statusDistribution['Ready for Production Deployment'] || 0;
  document.getElementById('summaryReadyTest').textContent = m.statusDistribution['Ready for Testing'] || 0;
  document.getElementById('summaryInDev').textContent = m.statusDistribution['Development In Progress'] || 0;
  document.getElementById('summaryReadyDev').textContent = m.statusDistribution['Ready for Development'] || 0;
  
  document.getElementById('summaryDefects').textContent = m.totalDefects;
  document.getElementById('summaryTestCases').textContent = m.totalTestCases;
  document.getElementById('summaryTestCov').textContent = m.testCoverage + '%';
  document.getElementById('summaryCritical').textContent = m.impactDistribution['Critical'] || 0;
  document.getElementById('summaryHigh').textContent = m.impactDistribution['High'] || 0;
  
  document.getElementById('summaryAssignees').textContent = Object.keys(m.assigneeDistribution).length;
  const topAssignee = Object.entries(m.assigneeDistribution).sort((a,b) => b[1] - a[1])[0];
  document.getElementById('summaryTopAssignee').textContent = topAssignee ? `${topAssignee[0]} (${topAssignee[1]})` : 'N/A';
  document.getElementById('summaryCompletion').innerHTML = `${m.completionRate}% ${changes ? formatChange(changes.completionRate, true) : ''}`;

  // Update charts
  createStatusChart(m.statusDistribution);
  createImpactChart(m.impactDistribution);
  createSprintChart(m.sprintDistribution);
  createProductChart(m.productDistribution);
  createAssigneeChart(m.assigneeDistribution);
  createPointsChart(m.pointsByStatus);
  
  // Add timeline visualization if multiple files
  if (historicalData.length > 1) {
    createTimelineChart();
  }
}

function updateChangesSection(changes) {
  const previous = historicalData[historicalData.length - 2];
  const current = historicalData[historicalData.length - 1];
  
  // Update timestamp info
  document.getElementById('changesTimestamp').textContent = 
    `Comparing ${previous.timestamp.toLocaleString()} ‚Üí ${current.timestamp.toLocaleString()}`;

  // Create changes cards
  const changesContent = document.getElementById('changesContent');
  
  const positiveChanges = [];
  const negativeChanges = [];
  const noChanges = [];

  // Categorize changes
  const changeItems = [
    { label: 'Total Stories', value: changes.totalStories, current: current.metrics.totalStories },
    { label: 'Ready for Production', value: changes.readyForProd, current: current.metrics.readyForProd },
    { label: 'In Progress', value: changes.inProgress, current: current.metrics.inProgress },
    { label: 'Story Points', value: changes.totalPoints, current: current.metrics.totalPoints },
    { label: 'Critical Stories', value: changes.criticalStories, current: current.metrics.criticalStories },
    { label: 'Total Test Cases', value: changes.totalTestCases, current: current.metrics.totalTestCases },
    { label: 'Test Coverage', value: parseFloat(changes.testCoverage), current: current.metrics.testCoverage + '%', isPercentage: true },
    { label: 'Total Defects', value: changes.totalDefects, current: current.metrics.totalDefects },
    { label: 'Completion Rate', value: parseFloat(changes.completionRate), current: current.metrics.completionRate + '%', isPercentage: true }
  ];

  changeItems.forEach(item => {
    if (item.value > 0) positiveChanges.push(item);
    else if (item.value < 0) negativeChanges.push(item);
    else noChanges.push(item);
  });

  // Build changes HTML
  let html = '';

  // Positive changes (improvements)
  if (positiveChanges.length > 0) {
    html += `
      <div class="summary-card" style="border-left:4px solid #10b981;">
        <h4 style="color:#10b981;">üìà Improvements</h4>
        <ul>`;
    positiveChanges.forEach(item => {
      const suffix = item.isPercentage ? '%' : '';
      html += `<li>‚Ä¢ ${item.label}: <strong>${item.current}</strong> <span style="color:#10b981;">(+${item.value}${suffix})</span></li>`;
    });
    html += `</ul></div>`;
  }

  // Negative changes (regressions)
  if (negativeChanges.length > 0) {
    html += `
      <div class="summary-card" style="border-left:4px solid #ef4444;">
        <h4 style="color:#ef4444;">üìâ Regressions</h4>
        <ul>`;
    negativeChanges.forEach(item => {
      const suffix = item.isPercentage ? '%' : '';
      html += `<li>‚Ä¢ ${item.label}: <strong>${item.current}</strong> <span style="color:#ef4444;">(${item.value}${suffix})</span></li>`;
    });
    html += `</ul></div>`;
  }

  // No changes
  if (noChanges.length > 0) {
    html += `
      <div class="summary-card" style="border-left:4px solid #6b7280;">
        <h4 style="color:#6b7280;">‚û°Ô∏è No Change</h4>
        <ul>`;
    noChanges.forEach(item => {
      html += `<li>‚Ä¢ ${item.label}: <strong>${item.current}</strong></li>`;
    });
    html += `</ul></div>`;
  }

  // Summary statistics
  html += `
    <div class="summary-card" style="border-left:4px solid #3b82f6;">
      <h4 style="color:#3b82f6;">üìä Change Summary</h4>
      <ul>
        <li>‚Ä¢ Metrics Improved: <strong style="color:#10b981;">${positiveChanges.length}</strong></li>
        <li>‚Ä¢ Metrics Declined: <strong style="color:#ef4444;">${negativeChanges.length}</strong></li>
        <li>‚Ä¢ Metrics Unchanged: <strong style="color:#6b7280;">${noChanges.length}</strong></li>
        <li>‚Ä¢ Time Between Reports: <strong>${getTimeDifference(previous.timestamp, current.timestamp)}</strong></li>
      </ul>
    </div>`;

  changesContent.innerHTML = html;
}

function getTimeDifference(startTime, endTime) {
  const diffMs = endTime - startTime;
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
  
  if (diffHours > 0) {
    return `${diffHours}h ${diffMinutes}m`;
  } else {
    return `${diffMinutes}m`;
  }
}

function showError(msg){
  const errorDiv = document.getElementById('error');
  errorDiv.textContent = msg;
  errorDiv.classList.add('show');
}
function hideError(){ document.getElementById('error').classList.remove('show'); }
function showProcessing(){ document.getElementById('processing').classList.add('show'); hideError(); }
function hideProcessing(){ document.getElementById('processing').classList.remove('show'); }

function processFile(file){
  showProcessing();

  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type:'array' });
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header:1, defval:'', raw:false });

      const processedData = processReleaseData(jsonData);
      if(processedData.length === 0){
        throw new Error('No valid data found. Ensure the table includes a "Release Name" header row and story rows.');
      }

      const metrics = calculateMetrics(processedData);
      globalMetrics = metrics;

      updateDashboard(metrics);
      showDashboard();
      hideProcessing();
    }catch(error){
      console.error('Error:', error);
      hideProcessing();
      showError('Error processing file: ' + error.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

/* ---------- FIX: make header detection less strict ---------- */
function findHeaderRow(jsonData){
  // Accept: "Release Name ‚Üë", "Release Name  ‚Üë", or plain "Release Name"
  const isReleaseHeader = (cell) => {
    const s = (cell || '').toString().trim();
    if (!s) return false;
    if (s === 'Release Name') return true;
    if (s === 'Release Name ‚Üë' || s === 'Release Name  ‚Üë') return true;
    // Sometimes Excel sorts add arrow right next to the word:
    if (s.includes('Release Name') && s.includes('‚Üë')) return true;
    return false;
  };

  for(let i = 0; i < jsonData.length; i++){
    const row = jsonData[i] || [];
    for(let j = 0; j < row.length; j++){
      if(isReleaseHeader(row[j])){
        // console.log(`Found "Release Name" header at row ${i + 1}, col ${String.fromCharCode(65 + j)}`);
        return { rowIndex: i, colOffset: j };
      }
    }
  }
  return { rowIndex: -1, colOffset: 0 };
}

function processReleaseData(jsonData){
  const headerInfo = findHeaderRow(jsonData);
  if(headerInfo.rowIndex === -1){
    throw new Error('Could not find a "Release Name" header row. Please ensure your Excel has this header.');
  }

  const headerIdx = headerInfo.rowIndex;
  const colOffset = headerInfo.colOffset;

  const dataRows = [];
  for(let i = headerIdx + 1; i < jsonData.length; i++){
    const row = jsonData[i];
    if(!row || row.length === 0 || !row.some(cell => cell && cell.toString().trim() !== '')) continue;

    const releaseName = (row[colOffset] || '').toString().trim();
    const sprint = (row[colOffset + 2] || '').toString().trim(); // Skip empty column C, use column D
    const storyNumber = (row[colOffset + 3] || '').toString().trim(); // Column E
    
    const releaseLower = releaseName.toLowerCase();
    const sprintLower = sprint.toLowerCase();
    if(releaseLower.includes('subtotal') || 
       releaseLower.includes('total') ||
       sprintLower.includes('subtotal') || 
       sprintLower.includes('total') ||
       sprintLower.includes('count')) {
      continue;
    }
    
    if(storyNumber && storyNumber.trim() !== ''){
      let storyPointValue = 0;
      const storyPointRaw = (row[colOffset + 11] || '').toString().trim(); // Column M
      if(storyPointRaw && !isNaN(parseFloat(storyPointRaw))){
        storyPointValue = parseFloat(storyPointRaw);
      }
      
      let defectCountValue = 0;
      const defectRaw = (row[colOffset + 15] || '').toString().trim(); // Column Q
      if(defectRaw && !isNaN(parseInt(defectRaw))){
        defectCountValue = parseInt(defectRaw);
      }
      
      let totalTestCasesValue = 0;
      const testCasesRaw = (row[colOffset + 16] || '').toString().trim(); // Column R 
      if(testCasesRaw && !isNaN(parseInt(testCasesRaw))){
        totalTestCasesValue = parseInt(testCasesRaw);
      }

      const story = {
        releaseName: releaseName,
        sprint: sprint,
        storyNumber: storyNumber,
        storyName: (row[colOffset + 4] || '').toString().trim(), // Column F
        productName: (row[colOffset + 5] || '').toString().trim(), // Column G
        epic: '', // Epic column removed
        storyStatus: (row[colOffset + 6] || '').toString().trim(), // Column H
        storyImpact: (row[colOffset + 7] || '').toString().trim(), // Column I
        requestor: (row[colOffset + 8] || '').toString().trim(), // Column J
        assignee: (row[colOffset + 9] || '').toString().trim(), // Column K
        storyOwner: (row[colOffset + 10] || '').toString().trim(), // Column L
        storyPoint: storyPointValue,
        developedBy: (row[colOffset + 12] || '').toString().trim(), // Column N
        lastModifiedBy: (row[colOffset + 13] || '').toString().trim(), // Column O
        lastModifiedDate: (row[colOffset + 14] || '').toString().trim(), // Column P
        defectCount: defectCountValue,
        totalTestCases: totalTestCasesValue,
        testCasesExecuted: 0
      };
      
      dataRows.push(story);
    }
  }
  
  // console.log(`Found header at row ${headerIdx + 1}, starting at column ${String.fromCharCode(65 + colOffset)}. Processed ${dataRows.length} stories.`);
  return dataRows;
}

/* ---------- FIX: compute storiesWithTestCases BEFORE using it ---------- */
function calculateMetrics(data){
  const metrics = {
    totalStories: data.length,
    statusDistribution: {},
    impactDistribution: {},
    sprintDistribution: {},
    productDistribution: {},
    assigneeDistribution: {},
    pointsByStatus: {},
    totalPoints: 0,
    totalDefects: 0,
    totalTestCases: 0,
    testCasesExecuted: 0
  };

  data.forEach(story => {
    if(story.storyStatus){
      metrics.statusDistribution[story.storyStatus] = (metrics.statusDistribution[story.storyStatus] || 0) + 1;
      metrics.pointsByStatus[story.storyStatus] = (metrics.pointsByStatus[story.storyStatus] || 0) + (Number(story.storyPoint) || 0);
    }
    if(story.storyImpact) metrics.impactDistribution[story.storyImpact] = (metrics.impactDistribution[story.storyImpact] || 0) + 1;
    if(story.sprint) metrics.sprintDistribution[story.sprint] = (metrics.sprintDistribution[story.sprint] || 0) + 1;
    if(story.productName) metrics.productDistribution[story.productName] = (metrics.productDistribution[story.productName] || 0) + 1;
    if(story.assignee) metrics.assigneeDistribution[story.assignee] = (metrics.assigneeDistribution[story.assignee] || 0) + 1;
    
    metrics.totalPoints += (Number(story.storyPoint) || 0);
    metrics.totalDefects += (Number(story.defectCount) || 0);
    metrics.totalTestCases += (Number(story.totalTestCases) || 0);
    metrics.testCasesExecuted += (Number(story.testCasesExecuted) || 0);
  });

  const readyForProd = metrics.statusDistribution['Ready for Production Deployment'] || 0;
  const criticalStories = metrics.impactDistribution['Critical'] || 0;
  const inProgress = (metrics.statusDistribution['Development In Progress'] || 0) + 
                     (metrics.statusDistribution['Ready for Testing'] || 0);

  // Compute BEFORE use
  const storiesWithTestCases = data.filter(story => (Number(story.totalTestCases) || 0) > 0).length;

  const testCoverage = metrics.totalStories > 0 
    ? ((storiesWithTestCases / metrics.totalStories) * 100).toFixed(1)
    : '0.0';
  const completionRate = metrics.totalStories > 0
    ? ((readyForProd / metrics.totalStories) * 100).toFixed(1)
    : '0.0';

  return {
    ...metrics,
    readyForProd,
    criticalStories,
    inProgress,
    testCoverage,
    completionRate,
    activeSprints: Object.keys(metrics.sprintDistribution).length,
    totalProducts: Object.keys(metrics.productDistribution).length
  };
}

function updateDashboard(m){
  document.getElementById('totalStories').textContent = m.totalStories;
  document.getElementById('readyForProd').textContent = m.readyForProd;
  document.getElementById('inProgress').textContent = m.inProgress;
  document.getElementById('totalPoints').textContent = m.totalPoints;
  document.getElementById('criticalStories').textContent = m.criticalStories;
  document.getElementById('totalTestCases').textContent = m.totalTestCases;
  document.getElementById('testCoverage').textContent = m.testCoverage + '%';
  document.getElementById('totalDefects').textContent = m.totalDefects;
  document.getElementById('activeSprints').textContent = m.activeSprints;
  document.getElementById('totalProducts').textContent = m.totalProducts;

  document.getElementById('summaryStories').textContent = m.totalStories;
  document.getElementById('summaryPoints').textContent = m.totalPoints;
  document.getElementById('summarySprints').textContent = m.activeSprints;
  document.getElementById('summaryProducts').textContent = m.totalProducts;
  
  document.getElementById('summaryReadyProd').textContent = m.statusDistribution['Ready for Production Deployment'] || 0;
  document.getElementById('summaryReadyTest').textContent = m.statusDistribution['Ready for Testing'] || 0;
  document.getElementById('summaryInDev').textContent = m.statusDistribution['Development In Progress'] || 0;
  document.getElementById('summaryReadyDev').textContent = m.statusDistribution['Ready for Development'] || 0;
  
  document.getElementById('summaryDefects').textContent = m.totalDefects;
  document.getElementById('summaryTestCases').textContent = m.totalTestCases;
  document.getElementById('summaryTestCov').textContent = m.testCoverage + '%';
  document.getElementById('summaryCritical').textContent = m.impactDistribution['Critical'] || 0;
  document.getElementById('summaryHigh').textContent = m.impactDistribution['High'] || 0;
  
  document.getElementById('summaryAssignees').textContent = Object.keys(m.assigneeDistribution).length;
  const topAssignee = Object.entries(m.assigneeDistribution).sort((a,b) => b[1] - a[1])[0];
  document.getElementById('summaryTopAssignee').textContent = topAssignee ? `${topAssignee[0]} (${topAssignee[1]})` : 'N/A';
  document.getElementById('summaryCompletion').textContent = m.completionRate + '%';

  createStatusChart(m.statusDistribution);
  createImpactChart(m.impactDistribution);
  createSprintChart(m.sprintDistribution);
  createProductChart(m.productDistribution);
  createAssigneeChart(m.assigneeDistribution);
  createPointsChart(m.pointsByStatus);
}

function createBarChart(containerId, data, colors){
  const chart = document.getElementById(containerId);
  const entries = Object.entries(data);
  if(entries.length === 0){
    chart.innerHTML = '<div style="padding:20px;text-align:center;color:#6b7280;">No data available</div>';
    return;
  }

  const maxVal = Math.max(...entries.map(e => e[1]));
  let html = '<div style="padding:20px;">';
  
  entries.sort((a,b) => b[1] - a[1]).forEach(([key, count]) => {
    const pct = maxVal ? (count / maxVal) * 100 : 0;
    const color = colors[key] || '#6b7280';
    const shortKey = key.length > 40 ? key.slice(0,40) + '...' : key;
    
    html += `
      <div style="margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <span style="font-weight:600;color:${color};" title="${key}">${shortKey}</span>
          <span style="font-weight:bold;color:#374151;">${count}</span>
        </div>
        <div style="background:#f3f4f6;border-radius:6px;height:12px;">
          <div style="background:${color};height:100%;width:${pct}%;border-radius:6px;transition:width .5s ease;"></div>
        </div>
      </div>`;
  });
  
  html += '</div>';
  chart.innerHTML = html;
}

function createStatusChart(data){
  const colors = {
    'Ready for Production Deployment': '#10b981',
    'Ready for Testing': '#3b82f6',
    'Development In Progress': '#f59e0b',
    'Ready for Development': '#8b5cf6',
    'Ready for Estimation': '#6b7280'
  };
  createBarChart('statusChart', data, colors);
}

function createImpactChart(data){
  const colors = {
    'Critical': '#dc2626',
    'High': '#ea580c',
    'Medium': '#f59e0b',
    'Low': '#10b981'
  };
  createBarChart('impactChart', data, colors);
}

function createSprintChart(data){
  createBarChart('sprintChart', data, {});
}

function createProductChart(data){
  createBarChart('productChart', data, {});
}

function createAssigneeChart(data){
  createBarChart('assigneeChart', data, {});
}

function createTimelineChart(){
  const chart = document.getElementById('timelineChart');
  if(!historicalData || historicalData.length < 2){
    chart.innerHTML = '<div style="padding:20px;text-align:center;color:#6b7280;">Upload multiple files to see timeline</div>';
    return;
  }

  let html = '<div style="padding:20px;overflow-x:auto;">';
  html += '<div style="display:flex;gap:20px;min-width:800px;">';
  
  historicalData.forEach((report, index) => {
    const isLatest = index === historicalData.length - 1;
    const borderColor = isLatest ? '#3b82f6' : '#e5e7eb';
    const bgColor = isLatest ? '#f0f9ff' : '#f9fafb';
    
    html += `
      <div style="flex:1;min-width:200px;border:2px solid ${borderColor};border-radius:8px;padding:12px;background:${bgColor};">
        <div style="font-weight:600;font-size:14px;margin-bottom:8px;color:#1f2937;">
          ${report.timestamp.toLocaleDateString()} ${report.timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
        </div>
        <div style="font-size:12px;color:#6b7280;margin-bottom:8px;">${report.filename.split('-').slice(-4).join('-').replace('.xlsx', '')}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px;">
          <div>Stories: <strong>${report.metrics.totalStories}</strong></div>
          <div>Points: <strong>${report.metrics.totalPoints}</strong></div>
          <div>Ready: <strong>${report.metrics.readyForProd}</strong></div>
          <div>Tests: <strong>${report.metrics.totalTestCases}</strong></div>
          <div>Defects: <strong>${report.metrics.totalDefects}</strong></div>
          <div>Coverage: <strong>${report.metrics.testCoverage}%</strong></div>
        </div>
        ${isLatest ? '<div style="text-align:center;margin-top:8px;color:#3b82f6;font-size:10px;font-weight:600;">LATEST</div>' : ''}
      </div>`;
  });
  
  html += '</div></div>';
  chart.innerHTML = html;
}

function createPointsChart(data){
  const colors = {
    'Ready for Production Deployment': '#10b981',
    'Ready for Testing': '#3b82f6',
    'Development In Progress': '#f59e0b',
    'Ready for Development': '#8b5cf6',
    'Ready for Estimation': '#6b7280'
  };
  createBarChart('pointsChart', data, colors);
}

function showDashboard(){
  document.getElementById('dashboard').classList.add('show');
  document.getElementById('dashboard').scrollIntoView({ behavior:'smooth' });
}

async function exportReport() {
  if (!globalMetrics) return;

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

  const toHide = document.querySelectorAll('.upload-section, #exportBtn');
  const restore = [];
  toHide.forEach(el => {
    restore.push({ el, display: el.style.display });
    el.style.display = 'none';
  });

  const canvas = await html2canvas(document.querySelector('.container'), {
    scale: 2,
    backgroundColor: '#ffffff',
    useCORS: true
  });

  restore.forEach(r => { r.el.style.display = r.display || ''; });

  const imgRatio = canvas.width / canvas.height;
  const targetW = 190;
  const targetH = targetW / imgRatio;
  
  pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, targetW, targetH);
  pdf.save(`Release_Progress_Report_${new Date().toISOString().slice(0,10)}.pdf`);
}

async function copyEmailBody() {
  try {
    if (!globalMetrics) {
      alert('Please load an Excel file first.');
      return;
    }

    const chartIds = [
      'statusChart',
      'impactChart', 
      'sprintChart',
      'productChart',
      'assigneeChart',
      'pointsChart'
    ];

    const chartImgs = [];
    for (const id of chartIds) {
      const el = document.getElementById(id);
      if (!el) continue;
      const canvas = await html2canvas(el, {
        backgroundColor: '#ffffff',
        scale: Math.max(2, window.devicePixelRatio || 1)
      });
      const dataUrl = canvas.toDataURL('image/png');
      chartImgs.push({ id, dataUrl });
    }

    const html = buildEmailHTML(globalMetrics, chartImgs);

    if (navigator.clipboard && window.ClipboardItem) {
      const blob = new Blob([html], { type: "text/html" });
      const plain = new Blob([stripHTML(html)], { type: "text/plain" });
      await navigator.clipboard.write([
        new ClipboardItem({
          "text/html": blob,
          "text/plain": plain
        })
      ]);
      alert('Email body copied successfully! You can now paste it into your email client.');
      return;
    }

    const win = window.open('', '_blank');
    win.document.open();
    win.document.write(html);
    win.document.close();
    alert('Email content opened in new tab. Select all, copy, then paste into your email client.');
  } catch (err) {
    console.error('Copy email failed:', err);
    alert('Could not copy email body. See console for details.');
  }
}

function buildEmailHTML(m, chartImgs) {
  const safe = s => (s == null ? '' : String(s));

  const activeAssignees = Object.keys(m.assigneeDistribution || {}).length;
  const topAssigneeEntry = Object.entries(m.assigneeDistribution || {}).sort((a,b)=>b[1]-a[1])[0];
  const mostActive = topAssigneeEntry ? topAssigneeEntry[0] : 'N/A';

  /* === Control sizes here === */
  const emailWidth = 1280;                               // full email width
  const chartsRowWidth = Math.min(1200, emailWidth - 80);// pair-of-charts row width
  const chartCellWidth = Math.floor((chartsRowWidth - 16) / 2);
  const labelPct = 62;

  const metricRow = (label, value) => [
    '<tr>',
      '<td style="padding:6px 10px;font-size:13px;line-height:1.3;border:1px solid #e5e7eb;background:#f9fafb;',
      'width:', labelPct, '%;max-width:', labelPct, '%;word-break:break-word;vertical-align:top;">', label, '</td>',
      '<td style="padding:6px 10px;font-size:13px;line-height:1.3;border:1px solid #e5e7eb;text-align:right;',
      'width:', (100 - labelPct), '%;max-width:', (100 - labelPct),
      '%;white-space:nowrap;vertical-align:top;"><b>', value, '</b></td>',
    '</tr>'
  ].join('');

  const tableWrap = rowsArr => [
    '<table cellpadding="0" cellspacing="0" width="100%" ',
    'style="border-collapse:collapse;table-layout:fixed;width:100%;">',
      rowsArr.join(''),
    '</table>'
  ].join('');

  // Blocks
  const overviewRows = [
    metricRow('Total Stories', safe(m.totalStories)),
    metricRow('Story Points', safe(m.totalPoints)),
    metricRow('Active Sprints', safe(m.activeSprints)),
    metricRow('Products', safe(m.totalProducts))
  ];

  const progressRows = [
    metricRow('Ready for Production', safe(m.statusDistribution['Ready for Production Deployment'] || 0)),
    metricRow('Ready for Testing', safe(m.statusDistribution['Ready for Testing'] || 0)),
    metricRow('In Development', safe(m.statusDistribution['Development In Progress'] || 0)),
    metricRow('Ready for Development', safe(m.statusDistribution['Ready for Development'] || 0))
  ];

  const qualityRows = [
    metricRow('Total Defects', safe(m.totalDefects)),
    metricRow('Test Coverage', safe(m.testCoverage) + '%'),
    metricRow('Critical Impact', safe(m.impactDistribution['Critical'] || 0)),
    metricRow('High Impact', safe(m.impactDistribution['High'] || 0))
  ];

  const teamRows = [
    metricRow('Active Assignees', activeAssignees),
    metricRow('Top Contributor', mostActive),
    metricRow('Completion Rate', safe(m.completionRate) + '%')
  ];

  const colBlock = (title, innerHtml) => [
    '<td valign="top" style="padding:8px;">',
      '<div style="font-weight:700;font-size:13px;margin-bottom:6px;color:#111827;">', title, '</div>',
      innerHtml,
    '</td>'
  ].join('');

  const fourColRow = [
    '<table role="presentation" cellpadding="0" cellspacing="0" width="100%" style="table-layout:fixed;width:100%;">',
      '<tr>',
        colBlock('Release Overview', tableWrap(overviewRows)),
        colBlock('Development Progress', tableWrap(progressRows)),
        colBlock('Quality Metrics', tableWrap(qualityRows)),
        colBlock('Team Performance', tableWrap(teamRows)),
      '</tr>',
    '</table>'
  ].join('');

  // Charts (2 per row)
  const titles = {
    statusChart: 'Story Status Distribution',
    impactChart: 'Impact Analysis',
    sprintChart: 'Sprint Distribution',
    productChart: 'Product Distribution',
    assigneeChart: 'Assignee Workload',
    pointsChart: 'Story Points by Status'
  };

  const imgTag = (src, alt) => [
    '<img src="', src, '" alt="', (alt || 'Chart image'),
    '" width="', chartCellWidth, '" style="display:block;width:', chartCellWidth,
    'px;height:auto;border-radius:6px;margin:6px 0;border:1px solid #e5e7eb;" />'
  ].join('');

  const chartsHTML = [
    '<table role="presentation" cellpadding="0" cellspacing="0" width="', chartsRowWidth,
    '" style="table-layout:fixed;width:', chartsRowWidth, 'px;margin:0 auto;"><tbody>'
  ];
  for (let i = 0; i < chartImgs.length; i += 2) {
    const left = chartImgs[i];
    const right = chartImgs[i + 1];
    chartsHTML.push('<tr>');

    chartsHTML.push(
      '<td valign="top" style="padding:8px;width:', chartCellWidth, 'px;max-width:', chartCellWidth, 'px;">',
      left
        ? '<div style="font-size:12px;color:#374151;margin-bottom:4px;"><b>' +
          (titles[left.id] || left.id) + '</b></div>' + imgTag(left.dataUrl, titles[left.id] || left.id)
        : '&nbsp;',
      '</td>'
    );

    chartsHTML.push(
      '<td valign="top" style="padding:8px;width:', chartCellWidth, 'px;max-width:', chartCellWidth, 'px;">',
      right
        ? '<div style="font-size:12px;color:#374151;margin-bottom:4px;"><b>' +
          (titles[right.id] || right.id) + '</b></div>' + imgTag(right.dataUrl, titles[right.id] || right.id)
        : '&nbsp;',
      '</td>'
    );

    chartsHTML.push('</tr>');
  }
  chartsHTML.push('</tbody></table>');
  const chartsTwoCol = chartsHTML.join('');

  // Final HTML - matching STLC structure
  return [
    '<!DOCTYPE html><html><head><meta charset="UTF-8"></head>',
    '<body style="margin:0;padding:0;background:#ffffff;">',
      '<table role="presentation" cellpadding="0" cellspacing="0" width="100%" style="background:#ffffff;">',
        '<tr><td align="center" style="padding:16px;">',
          '<table role="presentation" cellpadding="0" cellspacing="0" width="', emailWidth,
          '" style="width:', emailWidth, 'px;max-width:100%;">',
            '<tr><td style="padding:16px 20px;background:#111827;color:#ffffff;',
            'font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;">',
              '<div style="font-size:18px;font-weight:700;">Release Progress Report</div>',
              '<div style="font-size:12px;opacity:.85;">Generated ', new Date().toLocaleString(), '</div>',
            '</td></tr>',
            '<tr><td style="padding:18px 20px;',
            'font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;',
            'color:#111827;font-size:14px;">',
              fourColRow,
              '<div style="height:14px;line-height:14px;font-size:0;">&nbsp;</div>',
              '<div style="font-weight:700;font-size:15px;margin:6px 0 8px;color:#111827;">Charts</div>',
              chartsTwoCol,
              '<div style="margin-top:8px;font-size:12px;color:#6b7280;line-height:1.5;">',
                '<em>Note:</em> Release progress tracking with story status, sprint analysis, and team performance metrics.',
              '</div>',
            '</td></tr>',
            '<tr><td style="height:8px;background:#f3f4f6;"></td></tr>',
          '</table>',
        '</td></tr>',
      '</table>',
    '</body></html>'
  ].join('');
}

function stripHTML(html) {
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || '';
}
</script>
</body>
</html>
